name: Tag release on merge
on:
  workflow_dispatch: {}
permissions:
  contents: write
jobs:
  tag-release:
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref,
      'release/v')
    runs-on: ubuntu-latest
    steps:
    - name: Validate merge commit
      env:
        MERGE_SHA: ${{ github.event.pull_request.merge_commit_sha }}
      run: "if [ -z \"$MERGE_SHA\" ]; then\n  echo \"merge_commit_sha is empty; refusing\
        \ to tag to avoid tagging the wrong commit.\" >&2\n  exit 1\nfi\n"
    - name: Checkout merge commit
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        ref: ${{ github.event.pull_request.merge_commit_sha }}
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Configure git
      run: 'git config user.name "github-actions[bot]"

        git config user.email "github-actions[bot]@users.noreply.github.com"

        '
    - name: Fetch tags
      run: git fetch origin --tags --prune
    - name: Resolve version
      id: version
      env:
        HEAD_REF: ${{ github.event.pull_request.head.ref }}
      run: "python - <<'PY'\nimport os\nimport pathlib\nimport sys\nimport tomllib\n\
        \npath = pathlib.Path(\"pyproject.toml\")\ndata = tomllib.loads(path.read_text())\n\
        version = data.get(\"project\", {}).get(\"version\")\nif not version:\n  print(\"\
        Missing project.version in pyproject.toml.\", file=sys.stderr)\n  sys.exit(1)\n\
        \nhead_ref = os.environ.get(\"HEAD_REF\", \"\")\nif head_ref.startswith(\"\
        release/v\"):\n  expected = head_ref[len(\"release/v\") :]\n  if expected\
        \ != version:\n    print(\n        f\"Version mismatch: branch {expected}\
        \ vs pyproject {version}.\",\n        file=sys.stderr,\n    )\n    sys.exit(1)\n\
        \noutput_path = pathlib.Path(os.environ[\"GITHUB_OUTPUT\"])\noutput_path.write_text(f\"\
        version={version}\\n\")\nPY\n"
    - name: Create tag
      env:
        VERSION: ${{ steps.version.outputs.version }}
      run: "if git tag -l \"v${VERSION}\" | grep -q \"v${VERSION}\"; then\n  echo\
        \ \"Tag v${VERSION} already exists; skipping.\"\n  exit 0\nfi\ngit tag -a\
        \ \"v${VERSION}\" -m \"Release v${VERSION}\"\ngit push origin \"v${VERSION}\"\
        \n"
